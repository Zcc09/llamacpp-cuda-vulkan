services:
  # -------------------------------------------------------
  # Service 1: The AMD Worker (Vulkan)
  # -------------------------------------------------------
  rpc-amd:
    image: ghcr.io/zcc09/llamacpp-cuda-vulkan:latest
    container_name: llama-rpc-amd
    pull_policy: missing
    restart: unless-stopped
    # init: true handles SIGTERM correctly, preventing "port in use" errors on restart
    init: true
    devices:
      - /dev/dri:/dev/dri
      - /dev/kfd:/dev/kfd
    environment:
      # Force Vulkan to use system libraries
      - LD_LIBRARY_PATH=/usr/local/cuda/lib64:/usr/lib/x86_64-linux-gnu
    command: >
      /usr/local/bin/vulkan/rpc-server 
      --host 0.0.0.0 
      --port ${PORT_RPC}
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "${PORT_RPC}"]
      interval: 5s
      timeout: 5s
      retries: 5
      # Grace period: Wait 30s before checking health to allow boot
      start_period: 30s

  # -------------------------------------------------------
  # Service 2: The Main Server (CUDA + Web UI)
  # -------------------------------------------------------
  llama-main:
    image: ghcr.io/zcc09/llamacpp-cuda-vulkan:latest
    container_name: llama-main
    pull_policy: missing
    restart: unless-stopped
    ports:
      - "${PORT_MAIN}:8080"
    volumes:
      - "${HOST_MODEL_DIR}:/models"
    depends_on:
      rpc-amd:
        condition: service_healthy
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    environment:
      # Force CUDA to use real NVIDIA drivers
      - LD_LIBRARY_PATH=/usr/local/nvidia/lib:/usr/local/nvidia/lib64:/usr/local/cuda/lib64:/usr/lib/x86_64-linux-gnu
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
    command: >
      /usr/local/bin/cuda/llama-server 
      -m /models/${MODEL_FILE}
      --host 0.0.0.0 
      --port 8080 
      --rpc rpc-amd:${PORT_RPC}
      -ngl 99
      --mmap
      -fa
      -c ${CTX_SIZE}
      -ctk ${CACHE_TYPE_K}
      -ctv ${CACHE_TYPE_V}
      -b ${BATCH_SIZE}
      -ub ${UBATCH_SIZE}
      -t ${THREADS}
      --timeout 0

